<div class="grid-body-container">
  <nv-loading
    [loading]="isLoading"
    [showProgressbar]="true"
    [progressbarTop]="topPosition"
    [paragraphSize]="gridConfig.paging.pageSize"
  >
  </nv-loading>
  <ng-container *ngIf="(rows && rows.length > 0) || isLoading; else noContentToShow">
    <ng-container
      #rows
      *ngFor="let row of rows; let rowIndex=index; let odd=odd"
    >
      <div
        *ngIf="formsObject[row.id] ? (formsObject[row.id].changed | async) : true"
        class="grid-row"
        [attr.id]="rowIndex"
        [style.height.px]="gridConfig.rowHeight"
        [style.lineHeight.px]="gridConfig.rowHeight"
        [style.top.px]="rowIndex === 0 ? topPosition : 'unset'"
        [ngClass]="{
          'odd': odd,
          'selected': !!row['_checked'],
          'highlighted': focusedCellRowIndex === rowIndex,
          'edited': gridConfig.editForm.markBackgroundAsEdited ? !!row['_edited'] : false,
          'nv-first-row-sticky': rowIndex === 0 && gridConfig.pinFirstRow,
          'nv-first-row-border': rowIndex === 0 && gridConfig.pinFirstRow

        }"
        (contextmenu)="handleContextMenu(row, rowIndex, $event)"
      >
        <!-- Left-action -->
        <nv-left-action
          class="col-pinned-left nv-left-action"
          [style.top.px]="topPosition"
          [ngClass]="{
            'nv-first-row-sticky': rowIndex === 0 && gridConfig.pinFirstRow,
            'nv-first-row-border': rowIndex === 0 && gridConfig.pinFirstRow
          }"
          [rowIndex]="rowIndex"
          [rowChecked]="!!row['_checked']"
          [rowExpanded]="!!row['_expanded']"
          [rowSelectType]="gridConfig.rowSelectionType"
          [showMenuButton]="gridConfig.rowButtonsPosition === NvGridButtonsPosition.CollapsedLeft"
          [showExpandButton]="gridConfig.expandableComponentConfig"
          [showRowIndex]="gridConfig.showRowIndex"
          [paging]="gridConfig.paging"
          (selectRow)="selectRowFromLeftAction(rowIndex, $event.mouseEvent)"
          (expandRow)="expandedComponent.emit({rowIndex: rowIndex})"
          (menuButtonClicked)="handleContextMenu(row, rowIndex, $event.mouseEvent)"
        >
        </nv-left-action>
        <!-- Columns -->
        <nv-grid-cell
          *ngFor="let column of columns; let colIndex=index"
          [ngClass]="{
            'col-pinned-left': colIndex < gridConfig.pin.pinTill,
            'last-pinned-left': gridConfig.pin.pinTill  === colIndex + 1,
            disabled: formsObject[row.id] && formsObject[row.id].form.get(column.key).disabled,
            focused: focusedCellRowIndex === rowIndex
              && focusedCellColumnKey === column.key
              && editingCellRowIndex !== rowIndex
              && editingCellColumnKey !== column.key,
              invalid: formsObject[row.id] && formsObject[row.id].form.get(column.key).touched
              && formsObject[row.id].form.get(column.key).errors
          }"
          [error]="formsObject[row.id]
            && formsObject[row.id].form.get(column.key).errors
            && ((formsObject[row.id].form.get(column.key).errors | objectFirstElement) | translate)"
          [rootConfigChanged]="rootConfigChanged"
          [style.width.px]="column.width"
          [style.minWidth.px]="column.width"
          [style.left.px]="configurationService.getCellLeftPosition(gridConfig, colIndex)"
          [form]="formsObject[row.id] && formsObject[row.id].form"
          [customTooltip]="column.customTooltip ? column.customTooltip(row) : null"
          [allowJumpToNextCellIfInvalid]="gridConfig.editForm.allowJumpToNextCellIfInvalid"
          [cellValue]="row[column.key] | translate"
          [column]="column"
          [rowIndex]="rowIndex"
          [row]="row"
          [isEditing]="editingCellRowIndex === rowIndex && editingCellColumnKey === column.key"
          [columnTemplate]="columnTemplatesDictionary[column.key]"
          (click)="handleClick($event, row, rowIndex, column)"
          [columnEditTemplate]="columnEditTemplatesDictionary[column.key]"
          (nextCell)="jumpToNextCell(row, column.key, rowIndex, $event.form, $event.event)"
          (rowModified)="markModifiedRows(row)"
          (switch)="switchToViewMode()"
          (click)="clickInside()"
        >
        </nv-grid-cell>
        <ng-container *ngIf="!!row['_edited']; then saveOrDiscardTemplate; else defaultButtonsTemplate"></ng-container>
        <ng-template #saveOrDiscardTemplate>
          <div class="flex-container col-pinned-right nv-edit-form-buttons">
            <button
              *ngIf="gridConfig.editForm.showSaveChangesButton"
              [ngClass]="{'nv-first-row-sticky': rowIndex === 0 && gridConfig.pinFirstRow}"
              [style.width.px]="Constants.MENU_BUTTON_COLUMN_WIDTH"
              [style.top.px]="rowIndex === 0 && gridConfig.pinFirstRow ? topPosition : 0"
              nz-button
              nz-tooltip
              [nzTooltipTitle]="'saveChanges' | translate"
              [disabled]="formsObject[row.id] && !formsObject[row.id].form.valid"
              [nzSize]="'small'"
              (click)="save(row)"
            >
              <em
                nz-icon
                nzType="check"
              ></em>
            </button>
            <button
              *ngIf="gridConfig.editForm.showDiscardChangesButton"
              [disabled]="rowIndex === 0 && gridConfig.editForm.preventDiscardingFirstRow"
              [style.width.px]="Constants.MENU_BUTTON_COLUMN_WIDTH"
              [ngClass]="{'nv-first-row-sticky': rowIndex === 0 && gridConfig.pinFirstRow}"
              [ngStyle]="{'top.px': rowIndex === 0 && gridConfig.pinFirstRow ? topPosition : 0}"
              nz-button
              nz-tooltip
              [nzTooltipTitle]="'discardChanges' | translate"
              [nzSize]="'small'"
              (click)="restore(rowIndex, row)"
            >
              <em
                nz-icon
                nzType="close"
              ></em>
            </button>
          </div>
        </ng-template>
        <ng-template #defaultButtonsTemplate>
          <!-- Right Action -->
          <nv-right-action
            *ngIf="gridConfig.rowButtonsPosition === NvGridButtonsPosition.ExpandedRight"
            class="col-pinned-right"
            [ngClass]="{'nv-first-row-sticky': rowIndex === 0 && gridConfig.pinFirstRow}"
            [ngStyle]="{'top.px': rowIndex === 0 && gridConfig.pinFirstRow ? topPosition: 0}"
            [buttons]="gridConfig.buttons"
            [row]="row"
            [rowIndex]="rowIndex"
          >
          </nv-right-action>
        </ng-template>
      </div>
      <ng-container *ngIf="!!row['_expanded']">
        <nv-expand-view [componentConfig]="gridConfig.expandableComponentConfig"></nv-expand-view>
      </ng-container>
    </ng-container>
  </ng-container>
</div>
<ng-template #noContentToShow>
  <p>{{ 'noData' | translate }}</p>
</ng-template>
